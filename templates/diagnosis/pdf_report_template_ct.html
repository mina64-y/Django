{# templates/diagnosis/pdf_report_template_ct.html #}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CT ì§„ë‹¨ ì˜ˆì¸¡ ê²°ê³¼ PDF</title>
    <style>
        /* WeasyPrint ëŠ” ë³µì¡í•œ CSS ë¥¼ ì™„ë²½íˆ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ ìœ„ì£¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. */
        /* ì‹¤ì œ í°íŠ¸ ê²½ë¡œëŠ” static ì„¤ì • ë° generate_ct_diagnosis_pdf í•¨ìˆ˜ì˜ CSS ê°ì²´/íŒŒì¼ ê²½ë¡œì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. */
        @font-face {
            font-family: 'Malgun Gothic'; /* ë˜ëŠ” NanumGothic */
            /* src: url('{{ base_url }}/static/fonts/malgun.ttf'); */ /* CSS ê°ì²´ì—ì„œ ì²˜ë¦¬ ê°€ì • */
        }
        body {
            font-family: 'Malgun Gothic', sans-serif; /* CSS ê°ì²´ì—ì„œ ì²˜ë¦¬ ê°€ì • */
            font-size: 10pt;
            line-height: 1.5;
            color: #333;
        }
        .container { width: 95%; margin: 1cm auto; }
        h3 {
            text-align: center;
            color: #2c3e50; /* ì œëª© ìƒ‰ìƒ */
            border-bottom: 2px solid #3498db; /* íŒŒë€ìƒ‰ ê³„ì—´ ë°‘ì¤„ */
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h4 {
            color: #3498db; /* íŒŒë€ìƒ‰ ê³„ì—´ ì†Œì œëª© */
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #bdc3c7; /* íšŒìƒ‰ ë°‘ì¤„ */
            padding-bottom: 5px;
        }
        .section { margin-bottom: 20px; }
        .label { font-weight: bold; color: #555; min-width: 120px; display: inline-block; }
        .value { display: inline; }
        .plot-container { text-align: center; margin-top: 15px; margin-bottom: 15px; }
        img.plot {
            max-width: 70%; /* PDF í˜ì´ì§€ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì ˆ */
            height: auto;
            border: 1px solid #ddd;
            margin-top: 5px;
        }
        .interpretation {
            background-color: #ecf0f1; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
            border: 1px solid #bdc3c7;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px; /* ì•½ê°„ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
        }
        .warning {
            color: #e74c3c; /* ë¹¨ê°„ìƒ‰ ê³„ì—´ ê²½ê³  */
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed #e74c3c;
            text-align: center;
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h3>CT ì˜ìƒ ì˜ˆì¸¡ ê²°ê³¼ ë³´ê³ ì„œ</h3>

        <div class="section">
            <h4>ê¸°ë³¸ ì •ë³´</h4>
            <table>
                <tr>
                    <th><span class="label">í™˜ì ID</span></th>
                    <td><span class="value">{{ result.patient.user.id | default:"N/A" }}</span></td> {# ëª¨ë¸ êµ¬ì¡°ì— ë”°ë¼ ì ‘ê·¼ #}
                </tr>
                <tr>
                    <th><span class="label">ìš”ì²­ ì˜ë£Œì¸</span></th>
                    <td><span class="value">{{ result.requester.get_full_name|default:result.requester.username }}</span></td>
                </tr>
                <tr>
                    <th><span class="label">ìš”ì²­ ì‹œê°„</span></th>
                    <td><span class="value">{{ result.request_timestamp|date:"Yë…„ mì›” dì¼ H:i" }}</span></td>
                </tr>
                <tr>
                    <th><span class="label">ë¶„ì„ ì™„ë£Œ ì‹œê°„</span></th>
                    <td><span class="value">{{ completion_timestamp|date:"Yë…„ mì›” dì¼ H:i" | default:"N/A"}}</span></td> {# context ì—ì„œ ì „ë‹¬ë°›ê±°ë‚˜ result ê°ì²´ì—ì„œ ì ‘ê·¼ #}
                </tr>
                 <tr>
                    <th><span class="label">ìŠ¤ìº” ìœ í˜•</span></th>
                    <td><span class="value">{{ result.scan_type | default:"ì·Œì¥ CT" }}</span></td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h4>AI ì˜ˆì¸¡ ê²°ê³¼</h4>
            <table>
                <tr>
                    <th><span class="label">ë¶„ë¥˜ ì˜ˆì¸¡</span></th>
                     {# utils.pyì˜ pdf_context ìƒì„± ë¶€ë¶„ ì°¸ê³ í•˜ì—¬ ë³€ìˆ˜ëª… ì¼ì¹˜ í•„ìš” #}
                    <td><span class="value"><strong>{{ classification_prediction_display | default:"íŒë… ë¶ˆê°€" }}</strong></span></td>
                </tr>
                 <tr>
                    <th><span class="label">ì•” ì˜ì‹¬ í™•ë¥ </span></th>
                    {# utils.pyì˜ pdf_context ìƒì„± ë¶€ë¶„ ì°¸ê³ í•˜ì—¬ ë³€ìˆ˜ëª… ì¼ì¹˜ í•„ìš” #}
                    <td><span class="value">{{ classification_probability_percent | default:"N/A" }}</span></td>
                </tr>
                {% with vol=segmentation_metrics.volume_voxels %} {# with íƒœê·¸ë¡œ ë³€ìˆ˜ í• ë‹¹ #}
                <tr>
                    <th><span class="label">ë¶„í•  ê²°ê³¼ (ë³‘ë³€ ì˜ì‹¬ ì˜ì—­)</span></th>
                    <td>
                        <span class="value">
                            {% if vol is not None %}
                                {% if vol > 0 %}
                                    íƒì§€ë¨ (ìƒëŒ€ì  í¬ê¸° ì§€í‘œ: {{ vol }})
                                {% else %}
                                    íƒì§€ë˜ì§€ ì•ŠìŒ
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </td>
                </tr>
                {% endwith %}
            </table>
        </div>

        {# 2D ì‹œê°í™” ì´ë¯¸ì§€ í¬í•¨ #}
        {% if input_slice_plot_url or segmentation_map_plot_url %}
        <div class="section">
            <h4>ì°¸ê³ ìš© ë‹¨ë©´ ì´ë¯¸ì§€</h4>
            {% if input_slice_plot_url %}
            <div class="plot-container">
                <p>ì…ë ¥ ì˜ìƒ ëŒ€í‘œ ìŠ¬ë¼ì´ìŠ¤</p>
                <img class="plot" src="{{ input_slice_plot_url }}" alt="Input CT Slice">
            </div>
            {% endif %}
            {% if segmentation_map_plot_url %}
            <div class="plot-container">
                <p>ë¶„í•  ê²°ê³¼ ì˜¤ë²„ë ˆì´</p>
                <img class="plot" src="{{ segmentation_map_plot_url }}" alt="Segmentation Overlay">
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# 3D ì‹œê°í™” ì´ë¯¸ì§€ëŠ” ì—¬ê¸°ì„œ ì œì™¸ë¨ #}

        {% if gemini_interpretation %}
        <div class="section">
            <h4>AI ìë™ í•´ì„</h4>
            <div class="interpretation">
                <p>{{ gemini_interpretation|linebreaksbr }}</p> {# linebreaksbr ë¡œ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ #}
            </div>
            <div class="warning">
                ğŸš¨ ì¤‘ìš” ì•ˆë‚´ ğŸš¨<br>
                ë³¸ AI ì˜ˆì¸¡ ë° í•´ì„ ê²°ê³¼ëŠ” ì˜ë£Œì§„ì˜ ì§„ë‹¨ì„ ë³´ì¡°í•˜ê¸° ìœ„í•œ ì°¸ê³  ìë£Œì´ë©°, ìµœì¢…ì ì¸ ì˜í•™ì  íŒë‹¨ì´ë‚˜ ì§„ë‹¨ìœ¼ë¡œ ê°„ì£¼ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                ë°˜ë“œì‹œ ë‹´ë‹¹ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì—¬ ì •í™•í•œ ì§„ë‹¨ ë° ì¹˜ë£Œ ê³„íšì„ ì„¸ìš°ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </div>
        </div>
        {% endif %}

         {% if error_message %}
        <div class="section">
            <h4>ì˜¤ë¥˜ ì •ë³´</h4>
            <p style="color: #c0392b;">ì˜ˆì¸¡ ì²˜ë¦¬ ì¤‘ ë‹¤ìŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {{ error_message }}</p>
        </div>
        {% endif %}

    </div>
</body>
</html>